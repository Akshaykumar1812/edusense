{% extends 'admin/admin_layout.html' %}
{% load static %}
{% block content %}

<div class="main-panel">
    <div class="content-wrapper">
        <div class="row">

            <div class="row justify-content-center">
                <div class="col-md-6 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title text-center mb-4">Update Semester</h4>
                            
                            {% if error_message %}
                            <div class="alert alert-danger">
                                {{ error_message }}
                            </div>
                            {% endif %}

                            <form class="forms-sample" method="post" action="{% url 'edit_semester' semester.semester_id %}">
                                {% csrf_token %}
                                <div class="form-group ">
                                     <label for="exampleInputUsername2" class="col-sm-3">Semester</label>
                                    <input type="text" name="semester" class="form-control" id="exampleInputUsername2" value="{{ semester.semester_number }}" placeholder="Semester">
                                </div>
                                <div class="form-group ">
                                <label for="exampleInputUsername2" class="col-sm-3 ">Batch</label>
                                <select name="batch" class="form-control" id="batch-select" onchange="updateAcademicYears()">
                                    <option value="{{ current_batch.batch_id }}" selected>{{ current_batch.batch_name }}</option>
                                        {% for b in batches %}
                                            {% if b.batch_id != current_batch.batch_id %}
                                                <option value="{{ b.batch_id }}">{{ b.batch_name }}</option>
                                            {% endif %}
                                        {% endfor %}
                                </select>
                            </div>
                                <div class="form-group ">
                                <label for="exampleInputUsername2" class="col-sm-3 ">Academic Year</label>
                                <select name="department" class="form-control" id="academic-year-select">
                                    <option value="{{ current_academic.academic_id }}" selected>{{ current_academic.academic_year }}</option>
                                        {% for ay in academic_years %}
                                            {% if ay.academic_id != current_academic.academic_id %}
                                                <option value="{{ ay.academic_id }}" data-batch-id="{{ ay.fk_batch_id }}">{{ ay.academic_year }}</option>
                                            {% endif %}
                                        {% endfor %}
                                </select>
                            </div>
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-primary me-2">Update</button>
                                <a href="{% url 'semester' %}" class="btn btn-danger me-2 ">Back</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <!-- content-wrapper ends -->

<script>
function updateAcademicYears() {
    const batchId = document.getElementById('batch-select').value;
    const academicYearSelect = document.getElementById('academic-year-select');
    
    // Store current selection
    const currentSelection = academicYearSelect.value;
    
    // Hide all options first
    const options = academicYearSelect.querySelectorAll('option');
    options.forEach(option => {
        option.style.display = 'none';
    });
    
    // Show only options for selected batch
    options.forEach(option => {
        const batchAttr = option.getAttribute('data-batch-id');
        if (batchAttr === batchId || !batchAttr) { // !batchAttr for the current option (no data attribute)
            option.style.display = 'block';
        }
    });
    
    // Try to maintain current selection, otherwise select first visible
    let found = false;
    options.forEach(option => {
        if (option.value === currentSelection && option.style.display !== 'none') {
            option.selected = true;
            found = true;
        }
    });
    
    if (!found) {
        options.forEach(option => {
            if (option.style.display !== 'none') {
                option.selected = true;
                return false; // break
            }
        });
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateAcademicYears();
});
</script>

    {% endblock %}