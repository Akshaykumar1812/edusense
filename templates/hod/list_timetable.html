{% extends 'hod/hod_layout.html' %}
{% load static %}
{% block content %}

<div class="main-panel">
    <div class="content-wrapper">
        <div class="row">
            <div class="row justify-content-center">
                <div class="col-md-12 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h4 class="card-title text mb-4">Timetable</h4>
                                    <a href="{% url 'add_timetable' %}" class="btn btn-success">Add New Timetable</a>
                            </div>
                            <hr>
                            <!-- Filter Form -->
                            <form class="forms-sample mb-4" method="POST" action="">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="batch">Batch</label>
                                            <select name="batch" id="batch" class="form-control" onchange="filterAcademicYears()" required>
                                                <option value="" disabled selected>--Select Batch--</option>
                                                {% for batch in batches %}
                                                <option value="{{ batch.batch_id }}" {% if selected_batch == batch.batch_id|stringformat:"s" %} selected {% endif %} >{{batch.batch_name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="academic_year">Academic Year</label>
                                            <select name="academic_year" id="academic_year" class="form-control" onchange="filterSemesters()" required>
                                                <option value="" disabled selected>--Select Academic Year--</option>
                                                {% for year in academic_years %}
                                                <option value="{{ year.academic_id }}" 
                                                        data-batch="{{ year.fk_batch_id }}" 
                                                        {% if selected_academic == year.academic_id|stringformat:"s" %} selected {% endif %}>{{ year.academic_year }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="semester">Semester</label>
                                            <select name="semester" id="semester" class="form-control" required>
                                                <option value="" disabled selected>--Select Semester--</option>
                                                {% for semester_data in semesters %}
                                                <option value="{{ semester_data.semester.semester_id }}" 
                                                        data-batch="{{ semester_data.batch_id }}" 
                                                        data-academic="{{ semester_data.semester.fk_academic_id }}"
                                                        {% if selected_semester == semester_data.semester.semester_id|stringformat:"s" %} selected {% endif %}>
                                                 Semester {{ semester_data.semester.semester_number }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center mt-3">
                                    <button type="submit" class="btn btn-primary me-2">Show Timetable</button>
                                </div>
                            </form>
                            <hr>
                            <!-- Timetable Grid Display -->
                            {% if filters_applied %}
                                {% if has_data %}
                                    <div class="table-responsive mt-4">
                                        <table class="table table-bordered table-striped timetable-grid">
                                            <thead class="table-primary">
                                                <tr>
                                                    <th class="day-column">Day / Hour</th>
                                                    {% for hour in hours %}
                                                    <th class="hour-column">{{ hour }}{% if hour == 1 %}st{% elif hour == 2 %}nd{% elif hour == 3 %}rd{% else %}th{% endif %}</th>
                                                    {% endfor %}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for row in timetable_flat %}
                                                <tr>
                                                    <td class="day-cell">
                                                        <strong>{{ row.day }}</strong>
                                                    </td>
                                                    {% for hour_data in row.hours %}
                                                    <td class="timetable-cell">
                                                        {% if hour_data.subject %}
                                                            <div class="subject-name">
                                                                {{ hour_data.subject }}
                                                            </div>
                                                            <div class="faculty-name text-muted small">
                                                                {{ hour_data.faculty }}
                                                            </div>
                                                        {% else %}
                                                            <div class="empty-cell">-</div>
                                                        {% endif %}
                                                    </td>
                                                    {% endfor %}
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-center mt-4">
                                        <p class="text-muted">No timetable entries found for the selected filters.</p>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="text-center mt-4">
                                    <p class="text-muted">Please select batch, academic year, and semester to view the timetable.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
function filterAcademicYears() {
    const batchSelect = document.getElementById('batch');
    const academicYearSelect = document.getElementById('academic_year');
    const selectedBatch = batchSelect.value;
    
    // Get all academic year options
    const academicYearOptions = academicYearSelect.querySelectorAll('option');
    
    // Store current academic year selection
    const currentAcademicYear = academicYearSelect.value;
    
    // Filter academic years based on selected batch
    academicYearOptions.forEach(option => {
        const optionBatch = option.getAttribute('data-batch');
        
        if (selectedBatch === '') {
            // No batch selected, show only placeholder
            option.style.display = option.value === '' ? 'block' : 'none';
        } else {
            // Batch selected, show matching academic years
            if (optionBatch === selectedBatch || option.value === '') {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        }
    });
    
    // Restore academic year selection if it's still valid
    if (currentAcademicYear) {
        const currentOption = academicYearSelect.querySelector(`option[value="${currentAcademicYear}"]`);
        if (currentOption && currentOption.style.display !== 'none') {
            academicYearSelect.value = currentAcademicYear;
        } else {
            academicYearSelect.value = '';
        }
    }
    
    // Also filter semesters when batch changes
    filterSemesters();
}

function filterSemesters() {
    const batchSelect = document.getElementById('batch');
    const academicYearSelect = document.getElementById('academic_year');
    const semesterSelect = document.getElementById('semester');
    const selectedBatch = batchSelect.value;
    const selectedAcademic = academicYearSelect.value;
    
    // Get all semester options
    const semesterOptions = semesterSelect.querySelectorAll('option');
    
    // Store current semester selection
    const currentSemester = semesterSelect.value;
    
    // Filter semesters based on selected batch and academic year
    semesterOptions.forEach(option => {
        const optionBatch = option.getAttribute('data-batch');
        const optionAcademic = option.getAttribute('data-academic');
        
        if (selectedBatch === '' || selectedAcademic === '') {
            // No batch or academic year selected, show only placeholder
            option.style.display = option.value === '' ? 'block' : 'none';
        } else {
            // Both batch and academic year selected, show matching semesters
            if (optionBatch === selectedBatch && optionAcademic === selectedAcademic || option.value === '') {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        }
    });
    
    // Restore semester selection if it's still valid
    if (currentSemester) {
        const currentOption = semesterSelect.querySelector(`option[value="${currentSemester}"]`);
        if (currentOption && currentOption.style.display !== 'none') {
            semesterSelect.value = currentSemester;
        } else {
            semesterSelect.value = '';
        }
    }
}

// Initialize filters on page load
document.addEventListener('DOMContentLoaded', function() {
    filterAcademicYears();
    filterSemesters();
});
</script>

<style>
.timetable-grid {
    font-size: 12px;
    table-layout: fixed;
}

.timetable-grid th,
.timetable-grid td {
    text-align: center;
    vertical-align: middle;
    padding: 25px 4px;
    border: 1px solid #dee2e6;
}

.day-column {
    width: 100px;
    font-weight: bold;
    background-color: #f8f9fa;
}

.hour-column {
    width: 120px;
    font-weight: bold;
    background-color: #f8f9fa;
}

.day-cell {
    background-color: #f8f9fa;
    font-weight: bold;
    width: 100px;
}

.timetable-cell {
    min-height: 60px;
    max-width: 120px;
}

.subject-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.faculty-name {
    font-size: 15px;
    color: #6c757d;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.empty-cell {
    color: #dee2e6;
    font-style: italic;
}

@media (max-width: 1200px) {
    .timetable-grid {
        font-size: 11px;
    }
    .hour-column {
        width: 100px;
    }
    .timetable-cell {
        min-height: 50px;
        max-width: 100px;
    }
}

@media (max-width: 768px) {
    .timetable-grid {
        font-size: 10px;
    }
    .day-column {
        width: 80px;
    }
    .hour-column {
        width: 80px;
    }
    .timetable-cell {
        min-height: 40px;
        max-width: 80px;
        padding: 4px 2px;
    }
}
</style>

{% endblock %}